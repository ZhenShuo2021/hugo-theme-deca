{{- $currentPage := . -}}
{{- $meta := .Store.Get "sidebar-meta" -}}
{{- $sidebarData := false -}}
{{- if $meta -}}
  {{- $sidebarData = site.Store.Get (printf "sidebar-data-%s" $meta.sidebar) -}}
{{- end -}}


<input type="checkbox" id="mobile-menu-toggle">
<label for="mobile-menu-toggle" class="mobile-menu__overlay"></label>
<label for="mobile-menu-toggle" class="mobile-menu" id="mobile-menu">
  <div>
    <label for="mobile-menu-toggle" class="mobile-menu__close">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </label>

    <div class="mobile-menu__section mobile-menu__nav">
      <h3 class="mobile-menu__title">Navigation</h3>
      <ul class="mobile-menu__list">
        {{- range site.Menus.main -}}
          <li class="mobile-menu__item">
            {{- if or ($currentPage.IsMenuCurrent .Menu .) ($currentPage.HasMenuCurrent .Menu .) -}}
              <a class="mobile-menu__link mobile-menu__link--active" href="{{ .URL }}" data-no-swup
                >{{ .Name }}</a
              >
            {{- else -}}
              <a class="mobile-menu__link" href="{{ .URL }}" data-no-swup>{{ .Name }}</a>
            {{- end -}}
            {{- if .Children -}}
              <ul class="mobile-menu__submenu">
                {{- range .Children -}}
                  <li class="mobile-menu__item">
                    {{- if $currentPage.IsMenuCurrent .Menu . -}}
                      <a class="mobile-menu__link mobile-menu__link--active" href="{{ .URL }}" data-no-swup
                        >{{ .Name }}</a
                      >
                    {{- else -}}
                      <a class="mobile-menu__link" href="{{ .URL }}" data-no-swup>{{ .Name }}</a>
                    {{- end -}}
                  </li>
                {{- end -}}
              </ul>
            {{- end -}}
          </li>
        {{- end -}}
      </ul>
    </div>

    {{- if and $meta $sidebarData -}}
      {{- $sectionPage := site.GetPage "section" (index site.Params.sidebars $meta.sidebar).section -}}
      <div class="mobile-menu__section mobile-menu__sidebar">
        <h3 class="mobile-menu__title">Contents</h3>
        <ul class="mobile-menu__list">
          {{- if $sectionPage.Params.showTopLevelSidebar | default true -}}
            <li class="mobile-menu__item">
              <a
                class="mobile-menu__link {{ if eq $currentPage.RelPermalink $sectionPage.RelPermalink }}
                  mobile-menu__link--active
                {{ end }}"
                href="{{ $sectionPage.RelPermalink }}"
                data-no-swup>
                {{ or $sectionPage.Params.sidebar_label $sectionPage.Title }}
              </a>
            </li>
            {{- range $index, $item := $sidebarData.tree -}}
              {{- partial "inline/mobile-sidebar-item" (dict "item" $item "currentPage" $currentPage "path" (printf "%d" $index)) -}}
            {{- end -}}
          {{- else -}}
            {{- range $index, $item := $sidebarData.tree -}}
              {{- partial "inline/mobile-sidebar-item" (dict "item" $item "currentPage" $currentPage "path" (printf "%d" $index)) -}}
            {{- end -}}
          {{- end -}}
        </ul>
      </div>
    {{- end -}}


    <div class="mobile-menu__section">
      <h3 class="mobile-menu__title">Settings</h3>
      <div class="mobile-menu__icons">
        {{- range site.Params.header.social -}}
          <a
            class="mobile-menu__icon-btn"
            href="{{ .url }}"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="{{ .name }}"
            data-no-swup>
            <div class="icon">{{ .icon | safeHTML }}</div>
          </a>
        {{- end -}}


        <button class="mobile-menu__icon-btn" id="mobile-theme-toggle" aria-label="Toggle dark mode">
          {{- $sunIcon := resources.Get "icons/sun.svg" -}}
          {{- $moonIcon := resources.Get "icons/moon.svg" -}}
          <div class="icon theme-light">{{ $sunIcon.Content | safeHTML }}</div>
          <div class="icon theme-dark">{{ $moonIcon.Content | safeHTML }}</div>
        </button>
      </div>

      {{- if .IsTranslated -}}
        <div class="mobile-menu__lang-switcher">
          <input type="checkbox" id="mobile-lang-toggle" class="mobile-menu__lang-toggle">
          <label for="mobile-lang-toggle" class="mobile-menu__lang-button">
            <svg height="12" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657.0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657.0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
            </svg>
            <span>{{ site.Language.LanguageName }}</span>
          </label>
          <div class="mobile-menu__lang-options">
            {{- range .AllTranslations -}}
              <a
                href="{{ .RelPermalink }}"
                class="mobile-menu__lang-option {{ if eq .Language.Lang site.Language.Lang }}
                  mobile-menu__lang-option--active
                {{ end }}"
                data-no-swup>
                {{ .Language.LanguageName }}
              </a>
            {{- end -}}
          </div>
        </div>
      {{- end -}}
    </div>
  </div>
</label>

{{ define "_partials/inline/mobile-sidebar-item" }}
  {{- $item := .item -}}
  {{- $currentPage := .currentPage -}}
  {{- $page := $item.page -}}
  {{- $path := .path -}}

  {{- $pageMeta := $page.Store.Get "sidebar-meta" -}}
  {{- $displayName := $page.Title -}}
  {{- $isCollapsed := site.Params.sidebarCollapsed -}}
  {{- if $pageMeta -}}
    {{- $displayName = $pageMeta.displayName -}}
    {{- $isCollapsed = $pageMeta.isCollapsed -}}
  {{- end -}}

  {{- $isActive := eq $currentPage.RelPermalink $page.RelPermalink -}}
  {{- $hasChildren := gt (len $item.children) 0 -}}
  {{- $hasActivePage := or $isActive ($page.IsAncestor $currentPage) -}}

  {{- if $hasActivePage -}}
    {{- $isCollapsed = false -}}
  {{- end -}}


  <li class="mobile-menu__item">
    {{- if $hasChildren -}}
      {{- $checkboxId := printf "mobile-sidebar-toggle-%s" $path -}}
      <input
        type="checkbox"
        id="{{ $checkboxId }}"
        class="mobile-menu__sidebar-toggle"
        {{ if not $isCollapsed }}checked{{ end }}>
      <label for="{{ $checkboxId }}" class="mobile-menu__sidebar-item-collapsible">
        <a
          href="{{ $page.RelPermalink }}"
          class="mobile-menu__sidebar-link {{ if $isActive }}mobile-menu__link--active{{ end }}"
          data-no-swup
          >{{ $displayName }}</a
        >
      </label>
      <ul class="mobile-menu__sidebar-subsection">
        {{- range $index, $child := $item.children -}}
          {{- $childPath := printf "%s__%d" $path $index -}}
          {{- partial "inline/mobile-sidebar-item" (dict "item" $child "currentPage" $currentPage "path" $childPath) -}}
        {{- end -}}
      </ul>
    {{- else -}}
      <a
        class="mobile-menu__link {{ if $isActive }}mobile-menu__link--active{{ end }}"
        href="{{ $page.RelPermalink }}"
        data-no-swup
        >{{ $displayName }}</a
      >
    {{- end -}}
  </li>
{{- end -}}
