{{- /*
Renders an independent sidebar for the current section.
This partial ONLY handles HTML rendering. All data collection and processing
is handled by sidebar-init.html which is called once at build start.
*/
-}}

{{- $currentPage := . }}

{{- /* Get sidebar metadata from page store */ -}}
{{- $meta := .Store.Get "sidebar-meta" }}
{{- $sidebarData := false }}
{{- if $meta }}
  {{- $sidebarData = site.Store.Get (printf "sidebar-data-%s" $meta.sidebar) }}
{{- end }}

{{- /* Only render sidebar if we have valid data */ -}}
{{- if and $meta $sidebarData }}
{{- $sectionPage := site.GetPage "section" (index site.Params.sidebars $meta.sidebar).section }}
<nav class="sidebar">
  <ul>
    {{- /* Show section index if it exists */ -}}
    {{- if $sectionPage.Params.showTopLevelSidebar | default true }}
      <li>
        {{- /* Top-level _index.md: render as regular page item (no section/chevron) */ -}}
        <a href="{{ $sectionPage.RelPermalink }}" 
          class="{{ if eq $currentPage.RelPermalink $sectionPage.RelPermalink }}active{{ end }}">
          {{ or $sectionPage.Params.sidebar_label $sectionPage.Title }}
        </a>
      </li>
      {{- /* Render tree structure with dynamic state calculation */ -}}
      {{- range $sidebarData.tree }}
        {{- partial "inline/render-sidebar-item" (dict "item" . "currentPage" $currentPage) }}
      {{- end }}
    {{- else }}
      {{- /* If no section index content, just render tree structure */ -}}
      {{- range $sidebarData.tree }}
        {{- partial "inline/render-sidebar-item" (dict "item" . "currentPage" $currentPage) }}
      {{- end }}
    {{- end }}
  </ul>
</nav>
{{- end }}

{{ define "_partials/inline/render-sidebar-item" }}
  {{ $item := .item }}
  {{ $currentPage := .currentPage }}
  {{ $page := $item.page }}

  {{/* Get page metadata for display name and collapse state */}}
  {{ $pageMeta := $page.Store.Get "sidebar-meta" }}
  {{ $displayName := $page.Title }}
  {{ $isCollapsed := site.Params.sidebarCollapsed }}
  {{ if $pageMeta }}
    {{ $displayName = $pageMeta.displayName }}
    {{ $isCollapsed = $pageMeta.isCollapsed }}
  {{ end }}

  {{/* Calculate dynamic states */}}
  {{ $isActive := eq $currentPage.RelPermalink $page.RelPermalink }}
  {{ $hasChildren := gt (len $item.children) 0 }}
  {{ $hasActivePage := or $isActive ($page.IsAncestor $currentPage) }}

  {{/* If contains current page, force expand */}}
  {{ if $hasActivePage }}
    {{ $isCollapsed = false }}
  {{ end }}

  <li>
    {{ if $hasChildren }}
      <a href="{{ $page.RelPermalink }}" class="sidebar-item-collapsible {{ if $isActive }}active{{ end }}">
        {{ $displayName }}
        <button class="collapse-btn" 
          {{ if $isCollapsed }}
            aria-expanded="false" aria-label="Expand sidebar category '{{ .Title }}'"
          {{ else }}
            aria-expanded="true" aria-label="Collapse sidebar category '{{ .Title }}'"
          {{ end}}>
          {{ $chevronRightIcon := resources.Get "icons/chevron-right.svg" -}}
          <div class="collapse-icon {{ if not $isCollapsed }}expanded{{ end }}">
            {{/* inlined chevron-right for performance */}}
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round">
              <polyline points="9,18 15,12 9,6"></polyline>
            </svg>
          </div>
        </button>
      </a>
      <ul class="sidebar-subsection {{ if $isCollapsed }}collapsed{{ end }}">
        {{ range $item.children }}
          {{ partial "inline/render-sidebar-item" (dict "item" . "currentPage" $currentPage) }}
        {{ end }}
      </ul>
    {{ else }}
      <a href="{{ $page.RelPermalink }}" {{ if $isActive }}class="active"{{ end }}>
        {{ $displayName }}
      </a>
    {{ end }}
  </li>
{{ end }}
